---
title: "Folded area during ectopic folding"
author: "Bruno C. Vellutini"
date: "`r format(Sys.time(), '%d %B, %Y')`"
creation: February 18, 2021
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE, cache = FALSE)
knitr::opts_knit$set(root.dir = getwd())
library(ggplot2)
library(ggbeeswarm)
```

## Import measurements

We exported the area measurements from ROIs on cartographic projections and corrected the values to microns.

Sample of `results.txt`:

```
 	Label	Area	StdDev	X	Y	XM	YM	Perim.	BX	BY	Width	Height	Major	Minor	Angle	Circ.	Feret	IntDen	Median	Skew	Kurt	RawIntDen	FeretX	FeretY	FeretAngle	MinFeret	AR	Round	Solidity
1	btd-gap2_z3_t55s_E12_CARE_s24_0x0_w1724_h1106_fliph_f48-117.1.roi:1	98543.000	217.480	499.839	515.725	500.504	520.260	1823.388	395.000	180.000	200.000	744.000	712.253	176.158	87.248	0.372	746.496	120829781.000	1185	0.972	1.586	120829781.000	477	924	85.313	198.872	4.043	0.247	0.893
2	btd-gap2_z3_t55s_E7_CARE_s20_0x0_w1721_h1029_flipn_f23-92.1.roi:1	7095.000	103.782	253.389	841.867	252.628	839.782	459.002	213.000	746.000	85.000	171.000	170.569	52.962	110.872	0.423	177.775	7733816.000	1071	1.160	1.531	7733816.000	221	746	107.008	68.088	3.221	0.311	0.787
```

Sample of `corrected_results.txt`:

```
File "ROI Area"
rgap_1b_z3_t60s_E15_s20_0x70_w1777_h980_fliph_f45-114.1.roi 261.57975999999996
rgap_1b_z3_t60s_E15_s20_0x70_w1777_h980_fliph_f45-114.2.roi 10251.997106000003
```

```{r import-measurements}
# Load sample info
samples <- read.delim("samples.csv", sep = ",")

# Load raw ROI measurements from ImageJ
results <- read.delim("results.txt")

# Remove column with row number
results <- subset(results, select = -X.1)

# Remove slice number from the labels
results$Label <- gsub(":1", "", results$Label)

# Merge samples with results
results <- merge(samples, results, by = "Label", all.x = TRUE)

# Load corrected area measurements for cartographic projections
corrected <- read.delim("corrected_results.txt", sep = "")
colnames(corrected) <- c("Label", "AreaCorr")

# Merge corrected area to results
results <- merge(results, corrected, by = "Label", all.x = TRUE)

# Add column for embryo sorting
results$E <- as.numeric(sub(".*_E(\\d+)$", "\\1", results$Embryo))

# Transform data frame to order the stock for plotting
results$Stock <- factor(results$Stock, levels = c("wt", "btd", "eve", "prd"))
results$Sample <- factor(results$Sample, levels = c("wildtype", "control", "mutant"))
results$Genotype <- factor(results$Genotype, levels = c("wildtype", "heterozygote", "homozygote"))
results$Position <- factor(results$Position, levels = c("ant", "mid", "post"))

results <- results[order(results$Stock, results$Genotype, results$Position, results$E),]
rownames(results) <- 1:nrow(results)

# Save long data frame to file
write.csv(results, file = "combined_results.csv", row.names = FALSE)

# For downstream analysis, only consider TRUE folds
results <- results[results$Fold == TRUE, ]
```

## Calculate fold type percentage

```{r calculate-fold-type-percentage}


# Create data frame for tests
summary <- data.frame()

# Contrasts of single variables within stocks (het vs hom)
for (stock in unique(results$Stock)) {
  
  n_total <- length(unique(results[results$Stock == stock, ]$Embryo))
  n_het <- length(unique(results[results$Stock == stock & results$Genotype == "heterozygote", ]$Embryo))
  n_hom <- length(unique(results[results$Stock == stock & results$Genotype == "homozygote", ]$Embryo))
  
  row <- c(
    stock = stock,
    n_total = n_total,
    n_het = n_het,
    n_hom = n_hom
    
  )
  
  summary <- rbind(summary, as.data.frame(t(row)))
  
}
```

## Calculate total area per embryo

```{r calculate-total-area-per-embryo}

# Total folds and folded area per embryo
stats_total_per_embryo <- aggregate(
  AreaCorr ~ Embryo + Stock + Genotype,
  results[results$Fold == TRUE,],
  function(x) c(
    count = length(x),
    sum = sum(x)
    ))

# Makes column names nicer
stats_total_per_embryo <- do.call(data.frame, stats_total_per_embryo)
colnames(stats_total_per_embryo)[colnames(stats_total_per_embryo) == "AreaCorr.count"] <- "nFolds"

stats_total_per_embryo
```


```{r calculate-total-area-per-embryo}

# Total folds and folded area per Stock and Genotype
stats_total_per_stock <- aggregate(
  cbind(nFolds, AreaCorr.sum) ~ Stock + Genotype,
  stats_total_per_embryo,
  function(x) c(
    count = length(x),
    mean = mean(x),
    sd = sd(x),
    sum = sum(x)
    ))

# Makes column names nicer
stats_total_per_stock <- do.call(data.frame, stats_total_per_stock)
stats_total_per_stock <- subset(stats_total_per_stock, select = -AreaCorr.sum.count)
colnames(stats_total_per_stock)[colnames(stats_total_per_stock) == "nFolds.count"] <- "nEmbryos"
#colnames(stats_total_per_stock) <- c("Stock", "Genotype", "nEmbryos", "nFolds", "AreaCorr.sum.folds")
stats_total_per_stock <- stats_total_per_stock[order(stats_total_per_stock$Stock),]


# Total folds and folded area per embryo
stats_total_per_type <- aggregate(
  AreaCorr ~ Stock + Genotype + Type,
  results[results$Fold == TRUE,],
  function(x) c(
    count = length(x),
    mean = mean(x),
    sd = sd(x),
    sum = sum(x)
    ))
# Makes column names nicer
stats_total_per_type <- do.call(data.frame, stats_total_per_type)



stats <- aggregate(
  cbind(Area, AreaCorr) ~ stock + zygosity + status,
  mdlong[mdlong$status %in% c("md_start", "md_split"), ],
  function(x) c(
    count = length(x),
    mean = mean(x),
    sd = sd(x))
  )


```

```{r calculate-sum-mean-sd-type}

# Sum total folded area corrected
areacorr <- aggregate(results$AreaCorr, list(results$Embryo), sum)
colnames(areacorr) <- c("Embryo", "AreaCorr")

# Sum total folded area corrected for CF
areacorr_cf <- aggregate(results[results$Type == "CF",]$AreaCorr, list(results[results$Type == "CF",]$Embryo), sum)
colnames(areacorr_cf) <- c("Embryo", "AreaCorrCF")

# Sum total folded area corrected for EF
areacorr_ef <- aggregate(results[results$Type == "EF",]$AreaCorr, list(results[results$Type == "EF",]$Embryo), sum)
colnames(areacorr_ef) <- c("Embryo", "AreaCorrEF")

# Count number of folds
nfold <- data.frame(table(results$Embryo))
colnames(nfold) <- c("Embryo", "Folds")

# Count number of CF folds
nfold_cf <- data.frame(table(results[results$Type == "CF",]$Embryo))
colnames(nfold_cf) <- c("Embryo", "CFs")

# Count number of EF folds
nfold_ef <- data.frame(table(results[results$Type == "EF",]$Embryo))
colnames(nfold_ef) <- c("Embryo", "EFs")

# Get sample information
embryos <- unique(results[, c("Embryo", "Stock", "Sample", "Genotype")])

# Merge datasets
total <- merge(embryos, areacorr, by = "Embryo", all.x = TRUE)
total <- merge(total, areacorr_cf, by = "Embryo", all.x = TRUE)
total <- merge(total, areacorr_ef, by = "Embryo", all.x = TRUE)
total <- merge(total, nfold, by = "Embryo", all.x = TRUE)
total <- merge(total, nfold_cf, by = "Embryo", all.x = TRUE)
total <- merge(total, nfold_ef, by = "Embryo", all.x = TRUE)

# Transform data frame to order the stock for plotting
total <- transform(total, Stock=factor(Stock, levels = c("wt", "btd", "eve", "prd")))
```

## Statistics for number of folds

```{r print-info}
# Print btd embryos
print_btd <- sprintf("btd: embryos=%s (het=%s, hom=%s), folds=%s (het=%s, hom=%s)",
        length(embryos[embryos$Stock == "btd",]$Embryo), # total embryos
        length(embryos[embryos$Genotype == "heterozygote" & embryos$Stock == "btd",]$Embryo), # het embryos
        length(embryos[embryos$Genotype == "homozygote" & embryos$Stock == "btd",]$Embryo), # hom embryos
        
        length(results[results$Stock == "btd",]$Label), # total folds
        length(results[results$Genotype == "heterozygote" & results$Stock == "btd",]$Label), # het folds
        length(results[results$Genotype == "homozygote" & results$Stock == "btd",]$Label) # het folds
        )

# Print eve embryos
print_eve <- sprintf("eve: embryos=%s (het=%s, hom=%s), folds=%s (het=%s, hom=%s)",
        length(embryos[embryos$Stock == "eve",]$Embryo), # total embryos
        length(embryos[embryos$Genotype == "heterozygote" & embryos$Stock == "eve",]$Embryo), # het embryos
        length(embryos[embryos$Genotype == "homozygote" & embryos$Stock == "eve",]$Embryo), # hom embryos
        
        length(results[results$Stock == "eve",]$Label), # total folds
        length(results[results$Genotype == "heterozygote" & results$Stock == "eve",]$Label), # het folds
        length(results[results$Genotype == "homozygote" & results$Stock == "eve",]$Label) # het folds
        )

# Print prd embryos
print_prd <- sprintf("prd: embryos=%s (het=%s, hom=%s), folds=%s (het=%s, hom=%s)",
        length(embryos[embryos$Stock == "prd",]$Embryo), # total embryos
        length(embryos[embryos$Genotype == "heterozygote" & embryos$Stock == "prd",]$Embryo), # het embryos
        length(embryos[embryos$Genotype == "homozygote" & embryos$Stock == "prd",]$Embryo), # hom embryos
        
        length(results[results$Stock == "prd",]$Label), # total folds
        length(results[results$Genotype == "heterozygote" & results$Stock == "prd",]$Label), # het folds
        length(results[results$Genotype == "homozygote" & results$Stock == "prd",]$Label) # het folds
        )

# Print wt embryos
print_wt <- sprintf(" wt: embryos=%s, folds=%s, ant=%s, mid=%s, post=%s",
        length(embryos[embryos$Stock == "wt",]$Embryo), # total embryos
        length(results[results$Stock == "wt",]$Label), # total folds
        length(results[results$Stock == "wt" & results$Position == "ant",]$Label), # anterior folds
        length(results[results$Stock == "wt" & results$Position == "mid",]$Label), # middle folds
        length(results[results$Stock == "wt" & results$Position == "post",]$Label) # posterior folds
        )

print_wt
print_btd
print_eve
print_prd

# Save nfolds output to files
capture.output(print_wt, print_btd, print_eve, print_prd, file = "nfolds.txt")
```

## Statistics for folded area

```{r print-stats}
print_stats <- function(dataframe, stock, type) {
  filter_df <- (dataframe$Stock == stock & dataframe$Type == type)
  df <- na.omit(dataframe[filter_df,])
  df <- droplevels(df)

  # Define row
  row <- c(stock,
           type,
           mean(df$AreaCorr) / 1000,
           sd(df$AreaCorr) / 1000,
           length(df$AreaCorr)
           )
  
  # Summarize data
  print(sprintf("%s %s / area=%.3f±%.3f x 10^3 / n=%i",
                stock, type,
                mean(df$AreaCorr) / 1000,
                sd(df$AreaCorr) / 1000,
                length(df$AreaCorr)
                ))
  return(row)
}

# Save stats to data frame
stats <- data.frame()

# Bind row by row
stats <- rbind(stats, print_stats(results, "wt", "CF"))
stats <- rbind(stats, print_stats(results, "wt", "EF"))
stats <- rbind(stats, print_stats(results, "btd", "CF"))
stats <- rbind(stats, print_stats(results, "btd", "EF"))
stats <- rbind(stats, print_stats(results, "eve", "CF"))
stats <- rbind(stats, print_stats(results, "eve", "EF"))
stats <- rbind(stats, print_stats(results, "prd", "CF"))
stats <- rbind(stats, print_stats(results, "prd", "EF"))

# Add column names
colnames(stats) <- c("stock", "type", "mean", "sd", "n")

# Convert columns to numeric
stats[, 3:5] <- apply(stats[, 3:5], 2, as.numeric)

# Round up
stats[, 3:4] <- round(stats[, 3:4], digits=1)

# Write table to file
write.table(format(stats, digits=2), file = "stats.txt", quote = FALSE, row.names = FALSE, sep = "\t")
```

## Total folded area per embryo

Plot the total area of folded tissue per embryo of different genotypes.

```{r total-area-per-embryo}
ggplot(total, aes(Stock, AreaCorr, fill = Genotype)) +
  geom_boxplot(aes(color = Genotype), show.legend = FALSE, alpha = 0.5, outlier.shape = NA, width = 0.7, position = position_dodge(width = 1.0)) +
  geom_point(alpha = 0.8, size = 3, show.legend = FALSE, position = position_beeswarm(priority = "descending", dodge.width = 1.0, cex = 6)) +
  scale_y_continuous(labels = function(x) x / 1000) +
  labs(x = "stocks", y = expression(paste("total folded area per embryo ", (µm^2)~x~10^3))) +
  facet_grid(cols = vars(Stock), scales = "free_x") +
  scale_fill_manual(values=c("#cc79a7", "#56b4e9", "#e69f03")) +
  scale_color_manual(values=c("#cc79a7", "#56b4e9", "#e69f03")) +
  theme_classic(base_family = "DejaVu Sans") +
  theme(text =  element_text(size = 35),
        strip.background = element_blank(),
        panel.background = element_rect(colour = "black", size=1),
        )
ggsave("4-plots/total-area-per-embryo.png", width = 12, height = 4)
ggsave("4-plots/total-area-per-embryo.svg", width = 12, height = 4)
```

## Area of individual ectopic folds

```{r individual-area-per-ectopic-fold}
ggplot(results[results$Type == "EF",], aes(Genotype, AreaCorr, fill = Sample)) +
  geom_boxplot(aes(color = Sample), show.legend = FALSE, alpha = 0.5, outlier.shape = NA, width = 0.7, position = position_dodge(width = 1.0)) +
  geom_point(alpha = 0.8, size = 3, show.legend = FALSE, position = position_beeswarm(priority = "descending", dodge.width = 1.0, cex = 2.5)) +
  scale_y_continuous(labels = function(x) x / 1000) +
  labs(x = "stocks", y = expression(paste("area ", (µm^2)~x~10^3))) +
  scale_fill_manual(values=c("#cc79a7", "#56b4e9", "#e69f03")) +
  scale_color_manual(values=c("#cc79a7", "#56b4e9", "#e69f03")) +
  theme_classic(base_family = "DejaVu Sans") +
  theme(text =  element_text(size = 35),
        strip.background = element_blank(),
        panel.background = element_rect(colour = "black", size=1)
        )
ggsave("4-plots/individual-area-per-ectopic-fold.png", width = 12, height = 6)
ggsave("4-plots/individual-area-per-ectopic-fold.svg", width = 12, height = 6)
```


## Area of individual ectopic folds per position

```{r area-individual-folds-per-position}
ggplot(results, aes(Stock, AreaCorr, fill = Genotype)) +
  geom_boxplot(aes(color = Genotype), show.legend = FALSE, alpha = 0.5, outlier.shape = NA, width = 0.7, position = position_dodge(width = 1.0)) +
  geom_point(alpha = 0.8, size = 3, show.legend = FALSE, position = position_beeswarm(priority = "descending", dodge.width = 1.0, cex = 3)) +
  scale_y_continuous(labels = function(x) x / 1000) +
  labs(x = "stocks", y = expression(paste("area of individual folds ", (µm^2)~x~10^3))) +
  scale_fill_manual(values=c("#cc79a7", "#56b4e9", "#e69f03")) +
  scale_color_manual(values=c("#cc79a7", "#56b4e9", "#e69f03")) +
  facet_grid(cols = vars(Position), scales = "free") +
  theme_classic(base_family = "DejaVu Sans") +
  theme(text = element_text(size = 30),
        strip.background = element_blank(),
        panel.background = element_rect(colour = "black", size=1),
        axis.text.x = element_text(face = "italic"),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 15),
        )
ggsave("4-plots/individual-area-per-position.png", width = 12, height = 4)
ggsave("4-plots/individual-area-per-position.svg", width = 12, height = 4)
```

## Area of individual folds per type

```{r individual-area-per-type}
ggplot(results, aes(Type, AreaCorr, fill = Genotype)) +
  geom_boxplot(aes(color = Genotype), show.legend = FALSE, alpha = 0.5, outlier.shape = NA, width = 0.7, position = position_dodge(width = 1.0)) +
  geom_point(alpha = 0.8, size = 3, show.legend = FALSE, position = position_beeswarm(priority = "descending", dodge.width = 1.0, cex = 6)) +
  scale_y_continuous(labels = function(x) x / 1000) +
  labs(x = "stocks", y = expression(paste("area ", (µm^2)~x~10^3))) +
  facet_grid(cols = vars(Stock), scales = "free_x") +
  scale_fill_manual(values=c("#cc79a7", "#56b4e9", "#e69f03")) +
  scale_color_manual(values=c("#cc79a7", "#56b4e9", "#e69f03")) +
  theme_classic(base_family = "DejaVu Sans") +
  theme(text =  element_text(size = 35),
        strip.background = element_blank(),
        panel.background = element_rect(colour = "black", size=1),
        )
ggsave("4-plots/individual-area-per-type.png", width = 12, height = 4)
ggsave("4-plots/individual-area-per-type.svg", width = 12, height = 4)
```


## Statistics

The distribution is not normal. Using Wilcoxon test to compare the samples.

```{r stats}
sink('tests.txt')

print("Testing normality of distribution")
shapiro.test(results[(results$Stock != "prd" & results$Type == "EF" & results$Sample == "wildtype"),]$AreaCorr)
shapiro.test(results[(results$Stock != "prd" & results$Type == "EF" & results$Sample == "mutant"),]$AreaCorr)
print("Testing for difference between samples")
wilcox.test(results[(results$Stock != "prd" & results$Type == "EF" & results$Sample == "wildtype"),]$AreaCorr,
            results[(results$Stock != "prd" & results$Type == "EF" & results$Sample == "mutant"),]$AreaCorr)

print("t-test just to get the difference between sample means")
t.test(results[(results$Stock != "prd" & results$Type == "EF" & results$Sample == "wildtype"),]$AreaCorr,
       results[(results$Stock != "prd" & results$Type == "EF" & results$Sample == "mutant"),]$AreaCorr,
       var.equal = FALSE)

sink()
```