---
title: "Invaginated area during ectopic folding"
author: "Bruno C. Vellutini"
date: "`r format(Sys.time(), '%d %B, %Y')`"
creation: February 18, 2021
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE, cache = FALSE)
knitr::opts_knit$set(root.dir = "~/Dropbox/Projects/Cephalic_furrow/7-Paper/1-analyses/folded-area")
library(ggplot2)
library(ggbeeswarm)
```

## Analysis

We think the ectopic folding in cephalic furrow mutants occur because the
epithelial tissue is under compression, and buckles once the forces caused by
the mitotic domains and germ band extension cross a certain threshold. We
notice there is some sort of compensation in the ectopic folding events---when
an anterior fold is deep, no other folds form; when the anterior fold is
shallow, other folds form. We thus expect the total invaginated area would be
similar between mutant embryos, despite the variability in the folding events.

To estimate the invaginated area we used the cartographic projections of btd
and eve embryos (see 0-data), both heterozygotes and homozygotes, and visually
annotate the blastoderm cells that are invaginated into ectopic folding events.
This is done by tracking the cells that delimit the borders of ectopic
folds. We use ImageJ/Fiji selection brush to delineate the area of invagination
and save it as a ROI (see 1-rois). Using a script we compute the measurements
for individual folds, correct for the cartographic projection area and export
the data as csv file.

## Directories

- `0-data`: single-slice, cropped imsane projections
- `1-rois`: imagej rois for individual folds visually annotated (>1 per embryo)
- `2-cylinder`: correction matrix for imsane projections
- `3-tracking`: in case we need actual cell tracking

Filenames contain all the information from the original projection. For
example: `eve-Gap1_t60s_z3_E4_CARE_s20_0x334_w1850_h1040_fliph_f15-84.tif`

- `s20` = slice 20 in Z
- `0x334` = XY origin for cropping
- `w1850` = width of crop window (=projection width)
- `h1040` = height of crop window
- `fliph` = crop was flipped horizontally (flipn means no flipping)
- `f15-84` = subset of frames for this analysis (=70 frames)

## Load measurements

```{r load}
# Load raw ROI measurements from ImageJ
results <- read.delim("results.txt")

# Remove slice number from the labels
results$Label <- gsub(":1", "", results$Label)

# Split label at "_s" to get the embryo name. sapply gets all first elements of the split.
results$Embryo <- sapply(strsplit(results$Label, "_s"), "[", 1)

# Remove "_CARE" from embryo name
results$Embryo <- gsub("_CARE", "", results$Embryo)

# Add columns with sample information (needs manual update for new ROIs)
#results$Stock <- substring(results$Label, 1, 3)

# Load sample info and merge with results
samples <- read.delim("samples.csv", sep = ",")
results <- merge(results, samples, by = "Label", all.x = TRUE)

# Load corrected area measurements for cartographic projections
corrected <- read.delim("corrected_results.txt", sep = "")
colnames(corrected) <- c("Label", "AreaCorr")

# Merge corrected area to results
results <- merge(results, corrected, by = "Label", all.x = TRUE)

# Transform data frame to order the stock for plotting
results <- transform(results, Stock=factor(Stock, levels = c("wt", "btd", "eve", "prd")))

# Quick fix to add type of fold
results$Type <- "EF"
results[results$Stock == "wt" & results$Position == "mid",]$Type <- "CF"
results[results$Stock == "btd" & results$Genotype == "heterozygote",]$Type <- "CF"
results[results$Stock == "eve" & results$Genotype == "heterozygote",]$Type <- "CF"
results[results$Stock == "prd" & results$Genotype == "heterozygote",]$Type <- "CF"
results[results$Stock == "prd" & results$Position == "mid",]$Type <- "CF"

# Transform data frame to order the stock for plotting
results <- transform(results, Sample=factor(Sample, levels = c("wildtype", "control", "mutant")))

# Sum total folded area
area <- aggregate(results$Area, list(results$Embryo), sum)
colnames(area) <- c("Embryo", "Area")

# Sum total folded area corrected
areacorr <- aggregate(results$AreaCorr, list(results$Embryo), sum)
colnames(areacorr) <- c("Embryo", "AreaCorr")

# Count number of folds
nfold <- data.frame(table(results$Embryo))
colnames(nfold) <- c("Embryo", "Folds")

# Get sample information
embryos <- unique(results[, c("Embryo", "Stock", "Sample", "Genotype")])

# Merge datasets
total <- merge(area, areacorr, by = "Embryo", all.x = TRUE)
total <- merge(total, nfold, by = "Embryo", all.x = TRUE)
total <- merge(total, embryos, by = "Embryo", all.x = TRUE)

# Transform data frame to order the stock for plotting
total <- transform(total, Stock=factor(Stock, levels = c("wt", "btd", "eve", "prd")))
```


```{r print-info}
# Print btd embryos
sprintf("btd: embryos=%s (het=%s, hom=%s), folds=%s (het=%s, hom=%s)",
        length(embryos[embryos$Stock == "btd",]$Embryo), # total embryos
        length(embryos[embryos$Genotype == "heterozygote" & embryos$Stock == "btd",]$Embryo), # het embryos
        length(embryos[embryos$Genotype == "homozygote" & embryos$Stock == "btd",]$Embryo), # hom embryos
        
        length(results[results$Stock == "btd",]$Label), # total folds
        length(results[results$Genotype == "heterozygote" & results$Stock == "btd",]$Label), # het folds
        length(results[results$Genotype == "homozygote" & results$Stock == "btd",]$Label) # het folds
        )

# Print eve embryos
sprintf("eve: embryos=%s (het=%s, hom=%s), folds=%s (het=%s, hom=%s)",
        length(embryos[embryos$Stock == "eve",]$Embryo), # total embryos
        length(embryos[embryos$Genotype == "heterozygote" & embryos$Stock == "eve",]$Embryo), # het embryos
        length(embryos[embryos$Genotype == "homozygote" & embryos$Stock == "eve",]$Embryo), # hom embryos
        
        length(results[results$Stock == "eve",]$Label), # total folds
        length(results[results$Genotype == "heterozygote" & results$Stock == "eve",]$Label), # het folds
        length(results[results$Genotype == "homozygote" & results$Stock == "eve",]$Label) # het folds
        )

# Print prd embryos
sprintf("prd: embryos=%s (het=%s, hom=%s), folds=%s (het=%s, hom=%s)",
        length(embryos[embryos$Stock == "prd",]$Embryo), # total embryos
        length(embryos[embryos$Genotype == "heterozygote" & embryos$Stock == "prd",]$Embryo), # het embryos
        length(embryos[embryos$Genotype == "homozygote" & embryos$Stock == "prd",]$Embryo), # hom embryos
        
        length(results[results$Stock == "prd",]$Label), # total folds
        length(results[results$Genotype == "heterozygote" & results$Stock == "prd",]$Label), # het folds
        length(results[results$Genotype == "homozygote" & results$Stock == "prd",]$Label) # het folds
        )

# Print wt embryos
sprintf(" wt: embryos=%s, folds=%s, ant=%s, mid=%s, post=%s",
        length(embryos[embryos$Stock == "wt",]$Embryo), # total embryos
        length(results[results$Stock == "wt",]$Label), # total folds
        length(results[results$Stock == "wt" & results$Position == "ant",]$Label), # anterior folds
        length(results[results$Stock == "wt" & results$Position == "mid",]$Label), # middle folds
        length(results[results$Stock == "wt" & results$Position == "post",]$Label) # posterior folds
        )
```

## Total folded area per embryo

Plot with the total area of folded tissue in embryos with and without the
cephalic furrow. The values are the per embryo sum of the corrected areas of
individual folds positioned anterior, middle, and posterior.

It shows that homozygote mutants have a smaller area than heterozygote mutants,
which in turn are slightly smaller than wildtype total folded area.

```{r total-area-per-embryo}
ggplot(total, aes(Stock, AreaCorr, fill = Genotype)) +
  geom_boxplot(aes(color = Genotype), show.legend = FALSE, alpha = 0.5, outlier.shape = NA, width = 0.7, position = position_dodge(width = 1.0)) +
  geom_point(alpha = 0.8, size = 3, show.legend = FALSE, position = position_beeswarm(priority = "descending", dodge.width = 1.0, cex = 6)) +
  scale_y_continuous(labels = function(x) x / 1000) +
  labs(x = "stocks", y = expression(paste("total folded area per embryo ", (µm^2)~x~10^3))) +
  facet_grid(cols = vars(Stock), scales = "free_x") +
  scale_fill_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  scale_color_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  theme_classic(base_family = "DejaVu Sans") +
  theme(text =  element_text(size = 35),
        strip.background = element_blank(),
        panel.background = element_rect(colour = "black", size=1),
        )
ggsave("4-plots/total-area-per-embryo.png", width = 12, height = 4)
ggsave("4-plots/total-area-per-embryo.svg", width = 12, height = 4)

```

## Area of ectopic folds

```{r individual-area-per-ectopic-fold}
ggplot(results[results$Stock != "prd" & results$Type == "EF",], aes(Sample, AreaCorr, fill = Sample)) +
  geom_boxplot(aes(color = Sample), show.legend = FALSE, alpha = 0.5, outlier.shape = NA, width = 0.7, position = position_dodge(width = 1.0)) +
  geom_point(alpha = 0.8, size = 3, show.legend = FALSE, position = position_beeswarm(priority = "descending", dodge.width = 1.0, cex = 2.5)) +
  scale_y_continuous(labels = function(x) x / 1000) +
  labs(x = "stocks", y = expression(paste("area ", (µm^2)~x~10^3))) +
  scale_fill_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  scale_color_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  theme_classic(base_family = "DejaVu Sans") +
  theme(text =  element_text(size = 35),
        strip.background = element_blank(),
        panel.background = element_rect(colour = "black", size=1)
        )
ggsave("4-plots/individual-area-per-ectopic-fold.png", width = 12, height = 6)
ggsave("4-plots/individual-area-per-ectopic-fold.svg", width = 12, height = 6)
```

This plots shows the total area of folded tissue in embryos with and without
the cephalic furrow. Values are the sum of corrected areas of individual folds
per embryo.

```{r area-individual-folds}
ggplot(results, aes(Stock, AreaCorr, fill = Genotype)) +
  geom_boxplot(aes(color = Genotype), show.legend = FALSE, alpha = 0.5, outlier.shape = NA, width = 0.7, position = position_dodge(width = 1.0)) +
  geom_point(alpha = 0.8, size = 3, show.legend = FALSE, position = position_beeswarm(priority = "descending", dodge.width = 1.0, cex = 3)) +
  scale_y_continuous(labels = function(x) x / 1000) +
  labs(x = "stocks", y = expression(paste("area of individual folds ", (µm^2)~x~10^3))) +
  scale_fill_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  scale_color_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  facet_grid(cols = vars(Position), scales = "free") +
  theme_classic(base_family = "DejaVu Sans") +
  theme(text = element_text(size = 30),
        strip.background = element_blank(),
        panel.background = element_rect(colour = "black", size=1),
        axis.text.x = element_text(face = "italic"),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 15),
        )
ggsave("4-plots/area-individual-folds.png", width = 15, height = 8)
ggsave("4-plots/area-individual-folds.svg", width = 15, height = 8)
```





