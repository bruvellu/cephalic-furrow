---
title: "Germ band extension relative to CF and EF"
author: "Bruno C. Vellutini"
date: "`r format(Sys.time(), '%d %B, %Y')`"
creation: October 24, 2022
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE, cache = FALSE)
knitr::opts_knit$set(root.dir = "~/Dropbox/Projects/Cephalic_furrow/7-Paper/1-analyses/germband-extension")
library(ggplot2)
```

## Analysis

At which percentage of egg length (and how long after gastrulation) do ectopic
folds form in cephalic furrow mutants? We have a rough estimate based on a few
embryos but this can be quantified more accurately. A proper characterization of
this dynamics in mutants is important for the model.

## Directories

- `0-data`: 3D renderings of lateral views
- `1-rois`: Landmarks in RoiSets (.zip), measurements in tabular format (.txt)
- `2-plots`: Plotted data from ROIs

## Pre-processing

We exported the measurements of individual embryos using the "Measure" command
from Fiji. Each file contains 4 rows with predefined values. Row 1 and 2 are the
anterior and posterior limits of the vitelline envelope, respectively. The Slice
value of these two rows represents the frame at the onset of gastrulation (T=0).
Row 3 marks the position of the tip of the germ band when the cephalic furrow or
an ectopic fold first buckle in. The Slice correspond to the frame when this
happens. Row 4 marks the position of the tip of the germ band when the cephalic
furrow or ectopic folds reach maximum depth, immediately before they begin to
unfold. The Slice also corresponds to the frame when this happens.

Here is a sample file:

```
 	Label	X	Y	Slice
1	3D_btd-gap2_z3_t55s_E7.tif:0056-0237-0946:55	72.000	358.000	26
2	3D_btd-gap2_z3_t55s_E7.tif:0056-0237-0946:55	1820.833	314.167	26
3	3D_btd-gap2_z3_t55s_E7.tif:0056-0237-0946:55	1240.833	119.500	47
4	3D_btd-gap2_z3_t55s_E7.tif:0056-0237-0946:55	1050.167	115.500	56
```

For extracting information and plotting, these raw files need to be parsed,
processed, and compiled in a single data frame. The next block reads, process,
and creates an initial data frame.

```{r preprocess}
# List all txt files in ROIs folder
files = list.files(path = "1-rois", pattern="*.txt", full.names = TRUE)

# Function for pre-processing
process <- function(txtfile) {
  # Read txt file
  df <- read.delim(txtfile)
  # Get label and clean up embryo name
  label <- df$Label[1]
  embryo <- strsplit(df$Label[1], ":")[[1]][1]
  embryo <- gsub("3D_", "", embryo)
  embryo <- gsub(".tif", "", embryo)
  # Get X positions
  x_ant <- df$X[1]
  x_post <- df$X[2]
  x_buck <- df$X[3]
  x_deep <- df$X[4]
  # Get sizes
  size <- x_post - x_ant
  gb_pos_buck <- x_buck - x_ant
  gb_pos_deep <- x_deep - x_ant
  # Get percentages
  gb_pct_buck <- 100 - ((gb_pos_buck / size) * 100)
  gb_pct_deep <- 100 - ((gb_pos_deep / size) * 100)
  # Get frames
  frame_gastr <- df$Slice[1]
  frame_buck <- df$Slice[3]
  frame_deep <- df$Slice[4]
  # Save as vector
  mv <- c(label, embryo, x_ant, x_post, x_buck, x_deep,
          size, gb_pos_buck, gb_pos_deep, gb_pct_buck, gb_pct_deep,
          frame_gastr, frame_buck, frame_deep)
  return(mv)
}

# Define empty data frame
landmarks <- data.frame()

# Loop over files binding rows to data frame
for (txtfile in files) {
  gbrow <- process(txtfile)
  landmarks <- rbind(landmarks, gbrow)
}

# Define column names
colnames(landmarks) <- c("label", "embryo", "x_ant", "x_post", "x_buck", "x_deep",
                         "size", "gb_pos_buck", "gb_pos_deep", "gb_pct_buck", "gb_pct_deep",
                         "frame_gastr", "frame_buck", "frame_deep")
```

Next, we need to import the master dataset file to get some metadata. Most
important is the stock, zygosity, timestep, and gastrulation frame.

```{r merge}
# Import main dataset
datasets <- read.delim2("~/Dropbox/Projects/Cephalic_furrow/7-Paper/0-data/datasets.csv")

# Merge landmarks with datasets
germband <- merge(landmarks, datasets, by = "embryo", all.x = TRUE)

# Properly convert column types before any calculations
germband <- as.data.frame(lapply(germband, type.convert))

# Create columns with times (min)
germband$time_buck <- ((germband$frame_buck - germband$frame_gastr) * germband$timestep) / 60
germband$time_deep <- ((germband$frame_deep - germband$frame_gastr) * germband$timestep) / 60

# Make smaller dataset for plotting
columns <- c("embryo", "size", "status", "gb_pct", "gb_time", "stock", "zygosity", "folds_left")
gblong <- data.frame(
  c(germband$embryo, germband$embryo),
  c(germband$size, germband$size),
  c(rep("buck", length(germband$embryo)), rep("deep", length(germband$embryo))),
  c(germband$gb_pct_buck, germband$gb_pct_deep),
  c(germband$time_buck, germband$time_deep),
  c(germband$stock, germband$stock),
  c(germband$zygosity, germband$zygosity),
  c(germband$folds_left, germband$folds_left)
  )
colnames(gblong) <- columns
```

```{r values}
print_stats <- function(dataframe, stock) {
  # Subset data frame
  gb <- dataframe[dataframe$stock == stock,]
  # Select relevant columns
  cols <- c("embryo", "gb_pct_buck", "gb_pct_deep", "time_buck", "time_deep")
  # Summarize data
  print(stock)
  print(by(gb[,cols], gb$zygosity, summary))
  }

# Print summary statistics
print_stats(germband, "wt")
print_stats(germband, "btd")
print_stats(germband, "eve")
print_stats(germband, "prd")

capture.output(print_stats(germband, "wt"),
               print_stats(germband, "btd"),
               print_stats(germband, "eve"),
               print_stats(germband, "prd"),
               file = "stats.txt")
```

## Plotting

We want to identify the difference between the cephalic furrow and the ectopic
folds in the percentage of germ band extension, and the timing of formation
after gastrulation.

First, we plot the germ band extension (%) for homozygotes and heterozygotes at
two different moments: initial infolding/buckling (buck) and deepest point
(deep).

```{r plot-gb-pct}
ggplot(gblong, aes(factor(stock, level = c("wt", "btd", "eve", "prd")), gb_time, color = zygosity, fill = zygosity)) +
  geom_violin(draw_quantiles = c("0.5"), show.legend = TRUE, trim = TRUE, alpha = 0.3, scale = "area", adjust = 1) +
  geom_point(alpha = 0.8, size = 2, show.legend = TRUE, position = position_jitterdodge(dodge.width = 1, jitter.width = 0.10)) +
  scale_fill_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  scale_color_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  labs(title = "Ectopic folding by germ band position",
       x = "stocks", y = "germ band extension (%)") +
  facet_grid(rows = vars(status)) +
  theme_classic() +
  theme(text = element_text(size = 20),
        title = element_text(size = 15),
        legend.text = element_text(size = 15),
        strip.background = element_blank(),
        panel.background = element_rect(colour = "black", size=1)
        )
ggsave("2-plots/gb_pct.png", width = 15, height = 8)
ggsave("2-plots/gb_pct.svg", width = 15, height = 8)
```

Second, we plot the time after gastrulation (min).

```{r plot-gb-time}
ggplot(gblong, aes(factor(stock, level = c("wt", "btd", "eve", "prd")), gb_time, color = zygosity, fill = zygosity)) +
  geom_violin(draw_quantiles = c("0.5"), show.legend = TRUE, trim = TRUE, alpha = 0.3, scale = "area", adjust = 1) +
  geom_point(alpha = 0.8, size = 2, show.legend = TRUE, position = position_jitterdodge(dodge.width = 1, jitter.width = 0.10)) +
  scale_fill_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  scale_color_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  labs(title = "Ectopic folding by time after gastrulation",
       x = "stocks", y = "time after gastrulation (min)") +
  facet_grid(rows = vars(status)) +
  theme_classic() +
  theme(text = element_text(size = 20),
        title = element_text(size = 15),
        legend.text = element_text(size = 15),
        strip.background = element_blank(),
        panel.background = element_rect(colour = "black", size=1)
        )
ggsave("2-plots/gb_time.png", width = 15, height = 8)
ggsave("2-plots/gb_time.svg", width = 15, height = 8)
```


