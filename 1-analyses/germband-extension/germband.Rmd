---
title: "Germ band extension relative to ectopic folding"
author: "Bruno C. Vellutini"
date: "`r format(Sys.time(), '%d %B, %Y')`"
creation: October 24, 2022
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE, cache = FALSE)
knitr::opts_knit$set(root.dir = "~/Dropbox/Projects/Cephalic_furrow/7-Manuscript/1-analyses/germband-extension")
library(ggplot2)
library(ggbeeswarm)
```

## Pre-processing

We exported the measurements of individual embryos using the "Measure" command
from Fiji. Each file contains 4 rows with predefined values. Row 1 and 2 are the
anterior and posterior limits of the vitelline envelope, respectively. The Slice
value of these two rows represents the frame at the onset of gastrulation (T=0).
Row 3 marks the position of the tip of the germ band when the cephalic furrow or
an ectopic fold first buckle in. The Slice correspond to the frame when this
happens. Row 4 marks the position of the tip of the germ band when the cephalic
furrow or ectopic folds reach maximum depth, immediately before they begin to
unfold. The Slice also corresponds to the frame when this happens.

1. anterior_end (frame_gastrulation)
2. posterior_end (frame_gastrulation)
3. first_buckle (CF or EF)
4. max_depth (CF or EF)

Here is a sample file:

```
 	Label	X	Y	Slice
1	3D_btd-gap2_z3_t55s_E7.tif:0056-0237-0946:55	72.000	358.000	26
2	3D_btd-gap2_z3_t55s_E7.tif:0056-0237-0946:55	1820.833	314.167	26
3	3D_btd-gap2_z3_t55s_E7.tif:0056-0237-0946:55	1240.833	119.500	47
4	3D_btd-gap2_z3_t55s_E7.tif:0056-0237-0946:55	1050.167	115.500	56
```

For extracting information and plotting, these raw files need to be parsed,
processed, and compiled in a single data frame. The next block reads, process,
and creates an initial data frame.

```{r preprocess-fold-start}
# List all txt files in ROIs folder
files = list.files(path = "1-rois/fold_start", pattern="*.tsv", full.names = TRUE)

# Function for pre-processing
process_fold <- function(txtfile) {
  # Read txt file
  df <- read.delim(txtfile)
  # Get label and clean up embryo name
  label_tf <- df$Label[1]
  embryo <- strsplit(df$Label[1], ":")[[1]][1]
  embryo <- gsub("3D_", "", embryo)
  embryo <- gsub(".tif", "", embryo)
  # Get X positions
  x_ant <- df$X[1]
  x_post <- df$X[2]
  x_tf_buck <- df$X[3]
  x_tf_deep <- df$X[4]
  # Get sizes
  size <- x_post - x_ant
  gb_pos_tf_buck <- x_tf_buck - x_ant
  gb_pos_tf_deep <- x_tf_deep - x_ant
  # Get percentages
  # TODO: Fix the percentages here
  gb_pct_tf_buck <- 100 - ((gb_pos_tf_buck / size) * 100)
  gb_pct_tf_deep <- 100 - ((gb_pos_tf_deep / size) * 100)
  # Get frames
  frame_gastr <- df$Slice[1]
  frame_tf_buck <- df$Slice[3]
  frame_tf_deep <- df$Slice[4]
  # Save as vector
  mv <- c(label_tf, embryo, size, x_ant, x_post, x_tf_buck, x_tf_deep,
          gb_pos_tf_buck, gb_pos_tf_deep, gb_pct_tf_buck, gb_pct_tf_deep,
          frame_gastr, frame_tf_buck, frame_tf_deep)
  return(mv)
}

# Define empty data frame
fold_start <- data.frame()

# Loop over files binding rows to data frame
for (txtfile in files) {
  gbrow <- process_fold(txtfile)
  fold_start <- rbind(fold_start, gbrow)
}

# Define column names
colnames(fold_start) <- c("label_tf", "embryo", "size", "x_ant", "x_post", "x_tf_buck", "x_tf_deep",
                         "gb_pos_tf_buck", "gb_pos_tf_deep", "gb_pct_tf_buck", "gb_pct_tf_deep",
                         "frame_gastr", "frame_tf_buck", "frame_tf_deep")
```

```{r preprocess-md-start}
# List all txt files in ROIs folder
files = list.files(path = "1-rois/md_start", pattern="*.tsv", full.names = TRUE)

# Function for pre-processing
process_md <- function(txtfile) {
  # Read txt file
  df <- read.delim(txtfile)
  # Get label and clean up embryo name
  label_md <- df$Label[1]
  embryo <- strsplit(df$Label[1], ":")[[1]][1]
  embryo <- gsub("3D_", "", embryo)
  embryo <- gsub(".tif", "", embryo)
  # Get X positions
  x_md_start <- df$X[1]
  x_md_split <- df$X[2]
  # TODO: Get sizes
  # TODO: Get percentages
  
  # Get frames
  frame_md_start <- df$Slice[1]
  frame_md_split <- df$Slice[2]

    # Save as vector
  mv <- c(label_md, embryo, x_md_start, x_md_split, frame_md_start, frame_md_split)
  return(mv)
}

# Define empty data frame
md_start <- data.frame()

# Loop over files binding rows to data frame
for (txtfile in files) {
  gbrow <- process_md(txtfile)
  md_start <- rbind(md_start, gbrow)
}

# Define column names
colnames(md_start) <- c("label_md", "embryo", "x_md_start", "x_md_split", "frame_md_start", "frame_md_split")
```

## Dataset building

Next, we need to import the master dataset file to get some metadata. Most
important is the stock, zygosity, timestep, and gastrulation frame.

```{r merge}
# Import main dataset
datasets <- read.csv("../../0-data/datasets.csv")

# Merge landmarks with datasets
germband <- merge(fold_start, datasets, by = "embryo", all.x = TRUE)
germband <- merge(germband, md_start, by = "embryo", all.x = TRUE)

# Properly convert column types before any calculations
germband <- as.data.frame(lapply(germband, type.convert))

# Calculate GB percentage for MD start
germband$gb_pos_md_start <- germband$x_md_start - germband$x_ant
germband$gb_pos_md_split <- germband$x_md_split - germband$x_ant
# TODO: Fix the percentages here
germband$gb_pct_md_start <- 100 - ((germband$gb_pos_md_start / germband$size) * 100)
germband$gb_pct_md_split <- 100 - ((germband$gb_pos_md_split / germband$size) * 100)

# Create columns with times (min)
germband$time_tf_buck <- ((germband$frame_tf_buck - germband$frame_gastr) * germband$timestep) / 60
germband$time_tf_deep <- ((germband$frame_tf_deep - germband$frame_gastr) * germband$timestep) / 60
germband$time_md_start <- ((germband$frame_md_start - germband$frame_gastr) * germband$timestep) / 60
germband$time_md_split <- ((germband$frame_md_split - germband$frame_gastr) * germband$timestep) / 60

```

Convert the main dataframe into the long format for plotting

```{r gblong}
# Define variables for plotting
longvars <- c(
  "embryo",
  "stock",
  "zygosity",
  "size",
  "gb_pct_tf_buck",
  "gb_pct_tf_deep",
  "gb_pct_md_start",
  "gb_pct_md_split",
  "time_tf_buck",
  "time_tf_deep",
  "time_md_start",
  "time_md_split"
)

gblong <- reshape(
  germband[, longvars],
  varying = list(
    c(
      "gb_pct_tf_buck",
      "gb_pct_tf_deep",
      "gb_pct_md_start",
      "gb_pct_md_split"
    ),
    c(
      "time_tf_buck",
      "time_tf_deep",
      "time_md_start",
      "time_md_split"
    )
  ),
  v.names = c("gb_pct", "time"),
  timevar = "status",
  times = c("tf_buck", "tf_deep", "md_start", "md_split"),
  direction = "long"
)

# Remove the id column that reshape adds
gblong$id <- NULL

# Transform data frame to order the stock for plotting
gblong$stock = factor(gblong$stock, levels = c("wt", "btd", "eve", "prd", "stg", "btd-stg"))
gblong$zygosity = factor(gblong$zygosity, levels = c("wildtype", "heterozygote", "homozygote", "double heterozygote", "btd homozygote", "stg homozygote", "double homozygote"))
gblong <- gblong[order(gblong$stock, gblong$zygosity),]
rownames(gblong) <- 1:nrow(gblong)

# Save both data frames to file
write.csv(germband, file = "germband.csv", row.names = FALSE)
write.csv(gblong, file = "gblong.csv", row.names = FALSE)
```

## Descriptive statistics

Calculate and print the mean and standard deviation for all variables.

```{r values}
stats <- aggregate(cbind(gb_pct, gb_time) ~ stock + zygosity + status, gblong, function(x) c(count = length(x), mean = mean(x), sd = sd(x)))
stats <- do.call(data.frame, stats)
stats$stock = factor(stats$stock, levels = c("wt", "btd", "eve", "prd", "stg", "btd-stg"))
stats <- stats[order(stats$stock),]
rownames(stats) <- 1:nrow(stats)
stats
write.csv(stats, file = "stats.csv", row.names = FALSE)
```

```{r values}
print_stats <- function(dataframe, stock) {
  # Subset data frame
  gb <- dataframe[dataframe$stock == stock,]
  # Select relevant columns
  cols <- c("embryo", "gb_pct_tf_buck", "gb_pct_tf_deep", "time_tf_buck", "time_tf_deep")
  # Summarize data
  print("-------------------")
  print(stock)
  print(by(gb[,cols], gb$zygosity, summary))
  print("SD: gb_pct_tf_buck")
  print(by(gb[,"gb_pct_tf_buck"], gb$zygosity, sd))
  print("SD: time_tf_buck")
  print(by(gb[,"time_tf_buck"], gb$zygosity, sd))
  }

# Print summary statistics
print_stats(germband, "wt")
print_stats(germband, "btd")
print_stats(germband, "eve")
print_stats(germband, "prd")

capture.output(print_stats(germband, "wt"),
               print_stats(germband, "btd"),
               print_stats(germband, "eve"),
               print_stats(germband, "prd"),
               file = "stats.txt")
```

## Descriptive plots

We want to identify the difference between the cephalic furrow and the ectopic
folds in the percentage of germ band extension, and the timing of formation
after gastrulation.

First, we plot the germ band extension (%) for homozygotes and heterozygotes at
two different moments: initial infolding/buckling (buck) and deepest point
(deep).

```{r plot-gb-pct}
ggplot(gblong, aes(stock, gb_pct, fill = zygosity)) +
  geom_violin(draw_quantiles = c("0.5"), show.legend = TRUE, trim = TRUE, alpha = 0.7, scale = "count", adjust = 2) +
  geom_point(alpha = 0.8, size = 2, show.legend = TRUE, position = position_jitterdodge(dodge.width = 1, jitter.width = 0.1)) +
  scale_fill_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  scale_color_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  labs(title = "Ectopic folding by germ band position",
       x = "stocks", y = "germ band extension (%)") +
  facet_grid(rows = vars(status), cols = vars(stock), scales = "free") +
  theme_classic(base_family = "DejaVu Sans") +
  theme(text = element_text(size = 35),
        title = element_text(size = 15),
        legend.text = element_text(size = 15),
        strip.background = element_blank(),
        panel.background = element_rect(colour = "black", size=1)
        )
ggsave("2-plots/gb_pct.png", width = 15, height = 8)
ggsave("2-plots/gb_pct.svg", width = 15, height = 8)
```

Second, we plot the time after gastrulation (min).

```{r plot-gb-time}
ggplot(gblong, aes(stock, gb_time, fill = zygosity)) +
  geom_violin(draw_quantiles = c("0.5"), show.legend = TRUE, trim = TRUE, alpha = 0.7, scale = "count", adjust = 2) +
  geom_point(alpha = 0.8, size = 2, show.legend = TRUE, position = position_jitterdodge(dodge.width = 1, jitter.width = 0.1)) +
  scale_fill_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  scale_color_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  labs(title = "Ectopic folding by time after gastrulation",
       x = "stocks", y = "time after gastrulation (min)") +
  facet_grid(rows = vars(status), cols = vars(stock), scales = "free") +
  theme_classic(base_family = "DejaVu Sans") +
  theme(text = element_text(size = 35),
        title = element_text(size = 15),
        legend.text = element_text(size = 15),
        strip.background = element_blank(),
        panel.background = element_rect(colour = "black", size=1)
        )
ggsave("2-plots/gb_time.png", width = 15, height = 8)
ggsave("2-plots/gb_time.svg", width = 15, height = 8)
```

## Main figure plots

The above are nice descriptive plots. But for the figure, the most interesting
is the initial buckling/infolding relative to GB position and time after
gastrulation. First the germ band extension percentage:

```{r plot-gb-pct-buck}
ggplot(gblong[gblong$status == "buck",], aes(stock, gb_pct, fill = zygosity)) +
  geom_boxplot(aes(color = zygosity), show.legend = FALSE, alpha = 0.5, outlier.shape = NA, width = 0.7, position = position_dodge(width = 1.0)) +
  geom_point(alpha = 0.8, size = 3, show.legend = FALSE, position = position_beeswarm(priority = "descending", dodge.width = 1.0, cex = 6)) +
  scale_fill_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  scale_color_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  labs(x = "stocks", y = "germ band extension (%)") +
  facet_grid(cols = vars(stock), scales = "free") +
  theme_classic(base_family = "DejaVu Sans") +
  theme(text = element_text(size = 35),
        strip.background = element_blank(),
        panel.background = element_rect(colour = "black", size=1)
        )
ggsave("2-plots/gb_pct_buck.png", width = 12, height = 4)
ggsave("2-plots/gb_pct_buck.svg", width = 12, height = 4)
```

Then the time after gastrulation:

```{r plot-gb-time-buck}
ggplot(gblong[gblong$status == "buck",], aes(stock, gb_time, fill = zygosity)) +
  geom_boxplot(aes(color = zygosity), show.legend = FALSE, alpha = 0.5, outlier.shape = NA, width = 0.7, position = position_dodge(width = 1.0)) +
  geom_point(alpha = 0.8, size = 3, show.legend = FALSE, position = position_beeswarm(priority = "descending", dodge.width = 1.0, cex = 6)) +
  scale_fill_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  scale_color_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  labs(x = "stocks", y = "time after gastrulation (min)") +
  facet_grid(cols = vars(stock), scales = "free") +
  theme_classic(base_family = "DejaVu Sans") +
  theme(text = element_text(size = 35),
        strip.background = element_blank(),
        panel.background = element_rect(colour = "black", size=1)
        )
ggsave("2-plots/gb_time_buck.png", width = 12, height = 4)
ggsave("2-plots/gb_time_buck.svg", width = 12, height = 4)
```

## Supplementary plots

The deepest point plots are not super informative and will go into the
supplementary.

```{r plot-gb-pct-deep}
ggplot(gblong[gblong$status == "deep",], aes(stock, gb_pct, fill = zygosity)) +
  geom_boxplot(aes(color = zygosity), show.legend = FALSE, alpha = 0.5, outlier.shape = NA, width = 0.7, position = position_dodge(width = 1.0)) +
  geom_point(alpha = 0.8, size = 3, show.legend = FALSE, position = position_beeswarm(priority = "descending", dodge.width = 1.0, cex = 6)) +
  scale_fill_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  scale_color_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  labs(x = "stocks", y = "germ band extension (%)") +
  facet_grid(cols = vars(stock), scales = "free") +
  theme_classic(base_family = "DejaVu Sans") +
  theme(text = element_text(size = 35),
        #title = element_text(size = 15),
        #legend.text = element_text(size = 15),
        strip.background = element_blank(),
        panel.background = element_rect(colour = "black", size=1)
        )
ggsave("2-plots/gb_pct_deep.png", width = 12, height = 4)
ggsave("2-plots/gb_pct_deep.svg", width = 12, height = 4)
```

```{r plot-gb-time-deep}
ggplot(gblong[gblong$status == "deep",], aes(stock, gb_time, fill = zygosity)) +
  geom_boxplot(aes(color = zygosity), show.legend = FALSE, alpha = 0.5, outlier.shape = NA, width = 0.7, position = position_dodge(width = 1.0)) +
  geom_point(alpha = 0.8, size = 3, show.legend = FALSE, position = position_beeswarm(priority = "descending", dodge.width = 1.0, cex = 6)) +
  scale_fill_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  scale_color_manual(values=c("#56b4e9", "#e69f03", "#cc79a7")) +
  labs(x = "stocks", y = "time after gastrulation (min)") +
  facet_grid(cols = vars(stock), scales = "free") +
  theme_classic(base_family = "DejaVu Sans") +
  theme(text = element_text(size = 35),
        #title = element_text(size = 15),
        #legend.text = element_text(size = 15),
        strip.background = element_blank(),
        panel.background = element_rect(colour = "black", size=1)
        )
ggsave("2-plots/gb_time_deep.png", width = 12, height = 4)
ggsave("2-plots/gb_time_deep.svg", width = 12, height = 4)
```